define(["./when-4bbc8319","./Matrix2-ccd5b911","./ArcType-98ec98bf","./GeometryOffsetAttribute-1772960d","./BoundingRectangle-2b0e1a9b","./Transforms-d5c6ad6e","./RuntimeError-346a3079","./ComponentDatatype-93750d1a","./EllipsoidGeodesic-19ea7553","./EllipsoidTangentPlane-e000bae1","./GeometryAttribute-c30799b8","./GeometryInstance-5f4fe82b","./GeometryPipeline-548e76d2","./IndexDatatype-b7d979a6","./PolygonGeometryLibrary-d35c292d","./PolygonPipeline-83fb62b0","./VertexFormat-71718faa","./combine-83860057","./WebGLConstants-1c8239cc","./AxisAlignedBoundingBox-883f9c89","./IntersectionTests-4d6f5c54","./Plane-18bb00f8","./AttributeCompression-1f045b73","./EncodedCartesian3-08b8d980","./arrayRemoveDuplicates-18786327","./EllipsoidRhumbLine-aa9e6266","./GeometryAttributes-7827a6c2"],(function(e,t,r,o,a,i,n,s,l,u,p,c,m,y,g,d,h,f,b,_,v,P,x,w,C,T,I){"use strict";var A=new t.Cartographic,E=new t.Cartographic,G=new a.BoundingRectangle,O=new t.Cartesian3,V=new t.Cartesian3,F=new t.Cartesian3,D=new t.Cartesian3,L=new t.Cartesian3,N=new t.Cartesian3,H=new t.Cartesian3,R=new t.Cartesian3,M=new t.Cartesian3,S=new t.Cartesian2,B=new t.Cartesian2,k=new t.Cartesian3,z=new i.Quaternion,W=new t.Matrix3,Y=new t.Matrix3;function U(r){var a,n=r.vertexFormat,l=r.geometry,u=r.shadowVolume,c=l.attributes.position.values,m=c.length,y=r.wall,g=r.top||y,d=r.bottom||y;if(n.st||n.normal||n.tangent||n.bitangent||u){var h=r.boundingRectangle,f=r.tangentPlane,b=r.ellipsoid,_=r.stRotation,v=r.perPositionHeight,P=S;P.x=h.x,P.y=h.y;var x,w=n.st?new Float32Array(m/3*2):void 0;n.normal&&(x=v&&g&&!y?l.attributes.normal.values:new Float32Array(m));var C,T=n.tangent?new Float32Array(m):void 0,I=n.bitangent?new Float32Array(m):void 0,G=u?new Float32Array(m):void 0,U=0,j=0,Q=V,q=F,K=D,Z=!0,J=W,X=Y;X=0!==_?(C=i.Quaternion.fromAxisAngle(f._plane.normal,_,z),J=t.Matrix3.fromQuaternion(C,J),C=i.Quaternion.fromAxisAngle(f._plane.normal,-_,z),t.Matrix3.fromQuaternion(C,X)):(J=t.Matrix3.clone(t.Matrix3.IDENTITY,J),t.Matrix3.clone(t.Matrix3.IDENTITY,X));var $=0,ee=0;g&&d&&($=m/2,ee=m/3,m/=2);for(var te=0;te<m;te+=3){var re,oe,ae,ie,ne,se,le,ue,pe=t.Cartesian3.fromArray(c,te,k);n.st&&(re=t.Matrix3.multiplyByVector(J,pe,O),re=b.scaleToGeodeticSurface(re,re),oe=f.projectPointOntoPlane(re,B),t.Cartesian2.subtract(oe,P,oe),ae=s.CesiumMath.clamp(oe.x/h.width,0,1),ie=s.CesiumMath.clamp(oe.y/h.height,0,1),d&&(w[U+ee]=ae,w[U+1+ee]=ie),g&&(w[U]=ae,w[U+1]=ie),U+=2),(n.normal||n.tangent||n.bitangent||u)&&(ne=j+1,se=j+2,y?(te+3<m&&(le=t.Cartesian3.fromArray(c,te+3,L),Z&&(ue=t.Cartesian3.fromArray(c,te+m,N),v&&(a=pe,re=le,oe=ue,ae=void 0,ae=(ie=b).cartesianToCartographic(a,A).height,(a=ie.cartesianToCartographic(re,E)).height=ae,ie.cartographicToCartesian(a,re),(re=ie.cartesianToCartographic(oe,E)).height=ae-100,ie.cartographicToCartesian(re,oe)),t.Cartesian3.subtract(le,pe,le),t.Cartesian3.subtract(ue,pe,ue),Q=t.Cartesian3.normalize(t.Cartesian3.cross(ue,le,Q),Q),Z=!1),t.Cartesian3.equalsEpsilon(le,pe,s.CesiumMath.EPSILON10)&&(Z=!0)),(n.tangent||n.bitangent)&&(K=b.geodeticSurfaceNormal(pe,K),n.tangent&&(q=t.Cartesian3.normalize(t.Cartesian3.cross(K,Q,q),q)))):(Q=b.geodeticSurfaceNormal(pe,Q),(n.tangent||n.bitangent)&&(v&&(H=t.Cartesian3.fromArray(x,j,H),R=t.Cartesian3.cross(t.Cartesian3.UNIT_Z,H,R),R=t.Cartesian3.normalize(t.Matrix3.multiplyByVector(X,R,R),R),n.bitangent&&(M=t.Cartesian3.normalize(t.Cartesian3.cross(H,R,M),M))),q=t.Cartesian3.cross(t.Cartesian3.UNIT_Z,Q,q),q=t.Cartesian3.normalize(t.Matrix3.multiplyByVector(X,q,q),q),n.bitangent&&(K=t.Cartesian3.normalize(t.Cartesian3.cross(Q,q,K),K)))),n.normal&&(r.wall?(x[j+$]=Q.x,x[ne+$]=Q.y,x[se+$]=Q.z):d&&(x[j+$]=-Q.x,x[ne+$]=-Q.y,x[se+$]=-Q.z),(g&&!v||y)&&(x[j]=Q.x,x[ne]=Q.y,x[se]=Q.z)),u&&(y&&(Q=b.geodeticSurfaceNormal(pe,Q)),G[j+$]=-Q.x,G[ne+$]=-Q.y,G[se+$]=-Q.z),n.tangent&&(r.wall?(T[j+$]=q.x,T[ne+$]=q.y,T[se+$]=q.z):d&&(T[j+$]=-q.x,T[ne+$]=-q.y,T[se+$]=-q.z),g&&(v?(T[j]=R.x,T[ne]=R.y,T[se]=R.z):(T[j]=q.x,T[ne]=q.y,T[se]=q.z))),n.bitangent&&(d&&(I[j+$]=K.x,I[ne+$]=K.y,I[se+$]=K.z),g&&(v?(I[j]=M.x,I[ne]=M.y,I[se]=M.z):(I[j]=K.x,I[ne]=K.y,I[se]=K.z))),j+=3)}n.st&&(l.attributes.st=new p.GeometryAttribute({componentDatatype:s.ComponentDatatype.FLOAT,componentsPerAttribute:2,values:w})),n.normal&&(l.attributes.normal=new p.GeometryAttribute({componentDatatype:s.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:x})),n.tangent&&(l.attributes.tangent=new p.GeometryAttribute({componentDatatype:s.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:T})),n.bitangent&&(l.attributes.bitangent=new p.GeometryAttribute({componentDatatype:s.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:I})),u&&(l.attributes.extrudeDirection=new p.GeometryAttribute({componentDatatype:s.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:G}))}return r.extrude&&e.defined(r.offsetAttribute)&&(_=c.length/3,C=new Uint8Array(_),r.offsetAttribute===o.GeometryOffsetAttribute.TOP?g&&d||y?C=o.arrayFill(C,1,0,_/2):g&&(C=o.arrayFill(C,1)):(_=r.offsetAttribute===o.GeometryOffsetAttribute.NONE?0:1,C=o.arrayFill(C,_)),l.attributes.applyOffset=new p.GeometryAttribute({componentDatatype:s.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:C})),l}var j=new t.Cartographic,Q=new t.Cartographic,q={westOverIDL:0,eastOverIDL:0},K=new l.EllipsoidGeodesic;function Z(o,a,i,n,u){if(u=e.defaultValue(u,new t.Rectangle),!e.defined(o)||o.length<3)return u.west=0,u.north=0,u.south=0,u.east=0,u;if(i===r.ArcType.RHUMB)return t.Rectangle.fromCartesianArray(o,a,u);K.ellipsoid.equals(a)||(K=new l.EllipsoidGeodesic(void 0,void 0,a)),u.west=Number.POSITIVE_INFINITY,u.east=Number.NEGATIVE_INFINITY,u.south=Number.POSITIVE_INFINITY,u.north=Number.NEGATIVE_INFINITY,q.westOverIDL=Number.POSITIVE_INFINITY,q.eastOverIDL=Number.NEGATIVE_INFINITY;for(var p,c=1/s.CesiumMath.chordLength(n,a.maximumRadius),m=o.length,y=a.cartesianToCartographic(o[0],Q),g=j,d=1;d<m;d++)p=g,g=y,y=a.cartesianToCartographic(o[d],p),K.setEndPoints(g,y),X(K,c,u,q);return p=g,g=y,y=a.cartesianToCartographic(o[0],p),K.setEndPoints(g,y),X(K,c,u,q),u.east-u.west>q.eastOverIDL-q.westOverIDL&&(u.west=q.westOverIDL,u.east=q.eastOverIDL,u.east>s.CesiumMath.PI&&(u.east=u.east-s.CesiumMath.TWO_PI),u.west>s.CesiumMath.PI&&(u.west=u.west-s.CesiumMath.TWO_PI)),u}var J=new t.Cartographic;function X(e,t,r,o){for(var a=e.surfaceDistance,i=Math.ceil(a*t),n=0<i?a/(i-1):Number.POSITIVE_INFINITY,l=0,u=0;u<i;u++){var p=e.interpolateUsingSurfaceDistance(l,J);l+=n;var c=p.longitude;p=p.latitude;r.west=Math.min(r.west,c),r.east=Math.max(r.east,c),r.south=Math.min(r.south,p),r.north=Math.max(r.north,p),c=0<=c?c:c+s.CesiumMath.TWO_PI,o.westOverIDL=Math.min(o.westOverIDL,c),o.eastOverIDL=Math.max(o.eastOverIDL,c)}}var $=[];function ee(o){var a,i=o.polygonHierarchy,n=e.defaultValue(o.vertexFormat,h.VertexFormat.DEFAULT),l=e.defaultValue(o.ellipsoid,t.Ellipsoid.WGS84),u=e.defaultValue(o.granularity,s.CesiumMath.RADIANS_PER_DEGREE),p=e.defaultValue(o.stRotation,0),c=e.defaultValue(o.perPositionHeight,!1),m=c&&e.defined(o.extrudedHeight),y=e.defaultValue(o.height,0),d=e.defaultValue(o.extrudedHeight,y);m||(a=Math.max(y,d),d=Math.min(y,d),y=a),this._vertexFormat=h.VertexFormat.clone(n),this._ellipsoid=t.Ellipsoid.clone(l),this._granularity=u,this._stRotation=p,this._height=y,this._extrudedHeight=d,this._closeTop=e.defaultValue(o.closeTop,!0),this._closeBottom=e.defaultValue(o.closeBottom,!0),this._polygonHierarchy=i,this._perPositionHeight=c,this._perPositionHeightExtrude=m,this._shadowVolume=e.defaultValue(o.shadowVolume,!1),this._workerName="createPolygonGeometry",this._offsetAttribute=o.offsetAttribute,this._arcType=e.defaultValue(o.arcType,r.ArcType.GEODESIC),this._rectangle=void 0,this._textureCoordinateRotationPoints=void 0,this.packedLength=g.PolygonGeometryLibrary.computeHierarchyPackedLength(i)+t.Ellipsoid.packedLength+h.VertexFormat.packedLength+12}ee.fromPositions=function(t){return new ee({polygonHierarchy:{positions:(t=e.defaultValue(t,e.defaultValue.EMPTY_OBJECT)).positions},height:t.height,extrudedHeight:t.extrudedHeight,vertexFormat:t.vertexFormat,stRotation:t.stRotation,ellipsoid:t.ellipsoid,granularity:t.granularity,perPositionHeight:t.perPositionHeight,closeTop:t.closeTop,closeBottom:t.closeBottom,offsetAttribute:t.offsetAttribute,arcType:t.arcType})},ee.pack=function(r,o,a){return a=e.defaultValue(a,0),a=g.PolygonGeometryLibrary.packPolygonHierarchy(r._polygonHierarchy,o,a),t.Ellipsoid.pack(r._ellipsoid,o,a),a+=t.Ellipsoid.packedLength,h.VertexFormat.pack(r._vertexFormat,o,a),a+=h.VertexFormat.packedLength,o[a++]=r._height,o[a++]=r._extrudedHeight,o[a++]=r._granularity,o[a++]=r._stRotation,o[a++]=r._perPositionHeightExtrude?1:0,o[a++]=r._perPositionHeight?1:0,o[a++]=r._closeTop?1:0,o[a++]=r._closeBottom?1:0,o[a++]=r._shadowVolume?1:0,o[a++]=e.defaultValue(r._offsetAttribute,-1),o[a++]=r._arcType,o[a]=r.packedLength,o};var te=t.Ellipsoid.clone(t.Ellipsoid.UNIT_SPHERE),re=new h.VertexFormat,oe={polygonHierarchy:{}};return ee.unpack=function(r,o,a){o=e.defaultValue(o,0);var i=g.PolygonGeometryLibrary.unpackPolygonHierarchy(r,o);o=i.startingIndex,delete i.startingIndex;var n=t.Ellipsoid.unpack(r,o,te);o+=t.Ellipsoid.packedLength;var s=h.VertexFormat.unpack(r,o,re);o+=h.VertexFormat.packedLength;var l=r[o++],u=r[o++],p=r[o++],c=r[o++],m=1===r[o++],y=1===r[o++],d=1===r[o++],f=1===r[o++],b=1===r[o++],_=r[o++],v=r[o++];o=r[o];return(a=e.defined(a)?a:new ee(oe))._polygonHierarchy=i,a._ellipsoid=t.Ellipsoid.clone(n,a._ellipsoid),a._vertexFormat=h.VertexFormat.clone(s,a._vertexFormat),a._height=l,a._extrudedHeight=u,a._granularity=p,a._stRotation=c,a._perPositionHeightExtrude=m,a._perPositionHeight=y,a._closeTop=d,a._closeBottom=f,a._shadowVolume=b,a._offsetAttribute=-1===_?void 0:_,a._arcType=v,a.packedLength=o,a},ee.computeRectangle=function(o,a){var i=e.defaultValue(o.granularity,s.CesiumMath.RADIANS_PER_DEGREE),n=e.defaultValue(o.arcType,r.ArcType.GEODESIC),l=o.polygonHierarchy;o=e.defaultValue(o.ellipsoid,t.Ellipsoid.WGS84);return Z(l.positions,o,n,i,a)},ee.createGeometry=function(t){var r=t._vertexFormat,a=t._ellipsoid,n=t._granularity,l=t._stRotation,h=t._polygonHierarchy,f=t._perPositionHeight,b=t._closeTop,_=t._closeBottom,v=t._arcType;if(!((T=h.positions).length<3)){var P=u.EllipsoidTangentPlane.fromPoints(T,a),x=(h=g.PolygonGeometryLibrary.polygonsFromHierarchy(h,P.projectPointsOntoPlane.bind(P),!f,a)).hierarchy,w=h.polygons;if(0!==x.length){var C,T=x[0].outerRing,I=(T=g.PolygonGeometryLibrary.computeBoundingRectangle(P.plane.normal,P.projectPointOntoPlane.bind(P),T,l,G),[]),A=t._height,E=t._extrudedHeight,O={perPositionHeight:f,vertexFormat:r,geometry:void 0,tangentPlane:P,boundingRectangle:T,ellipsoid:a,stRotation:l,bottom:!1,top:!0,wall:!1,extrude:!1,arcType:v};if(t._perPositionHeightExtrude||!s.CesiumMath.equalsEpsilon(A,E,0,s.CesiumMath.EPSILON2))for(O.extrude=!0,O.top=b,O.bottom=_,O.shadowVolume=t._shadowVolume,O.offsetAttribute=t._offsetAttribute,C=0;C<w.length;C++){var V,F=function(e,t,r,o,a,i,n,s,l){var p={walls:[]};if(i||n){t=(C=g.PolygonGeometryLibrary.createGeometryFromPositions(e,t,r,a,s,l)).attributes.position.values;var m=C.indices;if(i&&n){var h,f=(i=t.concat(t)).length/3;(h=y.IndexDatatype.createTypedArray(f,2*m.length)).set(m);for(var b=m.length,_=f/2,v=0;v<b;v+=3){var P=h[v]+_,x=h[v+1]+_,w=h[v+2]+_;h[v+b]=w,h[v+1+b]=x,h[v+2+b]=P}C.attributes.position.values=i,a&&s.normal&&(s=C.attributes.normal.values,C.attributes.normal.values=new Float32Array(i.length),C.attributes.normal.values.set(s)),C.indices=h}else if(n){for(f=t.length/3,h=y.IndexDatatype.createTypedArray(f,m.length),v=0;v<m.length;v+=3)h[v]=m[v+2],h[v+1]=m[v+1],h[v+2]=m[v];C.indices=h}p.topAndBottom=new c.GeometryInstance({geometry:C})}var C=o.outerRing,T=u.EllipsoidTangentPlane.fromPoints(C,e).projectPointsOntoPlane(C,$);d.PolygonPipeline.computeWindingOrder2D(T)===d.WindingOrder.CLOCKWISE&&(C=C.slice().reverse());var I=g.PolygonGeometryLibrary.computeWallGeometry(C,e,r,a,l);p.walls.push(new c.GeometryInstance({geometry:I}));var A=o.holes;for(v=0;v<A.length;v++){var E=A[v];T=u.EllipsoidTangentPlane.fromPoints(E,e).projectPointsOntoPlane(E,$);d.PolygonPipeline.computeWindingOrder2D(T)===d.WindingOrder.COUNTER_CLOCKWISE&&(E=E.slice().reverse()),I=g.PolygonGeometryLibrary.computeWallGeometry(E,e,r,a,l),p.walls.push(new c.GeometryInstance({geometry:I}))}return p}(a,w[C],n,x[C],f,b,_,r,v);b&&_?(V=F.topAndBottom,O.geometry=g.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(V.geometry,A,E,a,f)):b?((V=F.topAndBottom).geometry.attributes.position.values=d.PolygonPipeline.scaleToGeodeticHeight(V.geometry.attributes.position.values,A,a,!f),O.geometry=V.geometry):_&&((V=F.topAndBottom).geometry.attributes.position.values=d.PolygonPipeline.scaleToGeodeticHeight(V.geometry.attributes.position.values,E,a,!0),O.geometry=V.geometry),(b||_)&&(O.wall=!1,V.geometry=U(O),I.push(V));var D=F.walls;O.wall=!0;for(var L=0;L<D.length;L++){var N=D[L];O.geometry=g.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(N.geometry,A,E,a,f),N.geometry=U(O),I.push(N)}}else for(C=0;C<w.length;C++){var H,R,M=new c.GeometryInstance({geometry:g.PolygonGeometryLibrary.createGeometryFromPositions(a,w[C],n,f,r,v)});M.geometry.attributes.position.values=d.PolygonPipeline.scaleToGeodeticHeight(M.geometry.attributes.position.values,A,a,!f),O.geometry=M.geometry,M.geometry=U(O),e.defined(t._offsetAttribute)&&(R=M.geometry.attributes.position.values.length,H=new Uint8Array(R/3),R=t._offsetAttribute===o.GeometryOffsetAttribute.NONE?0:1,o.arrayFill(H,R),M.geometry.attributes.applyOffset=new p.GeometryAttribute({componentDatatype:s.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:H})),I.push(M)}return(P=m.GeometryPipeline.combineInstances(I)[0]).attributes.position.values=new Float64Array(P.attributes.position.values),P.indices=y.IndexDatatype.createTypedArray(P.attributes.position.values.length/3,P.indices),T=P.attributes,l=i.BoundingSphere.fromVertices(T.position.values),r.position||delete T.position,new p.Geometry({attributes:T,indices:P.indices,primitiveType:P.primitiveType,boundingSphere:l,offsetAttribute:t._offsetAttribute})}}},ee.createShadowVolume=function(e,t,r){var o=e._granularity,a=e._ellipsoid;t=t(o,a),r=r(o,a);return new ee({polygonHierarchy:e._polygonHierarchy,ellipsoid:a,stRotation:e._stRotation,granularity:o,perPositionHeight:!1,extrudedHeight:t,height:r,vertexFormat:h.VertexFormat.POSITION_ONLY,shadowVolume:!0,arcType:e._arcType})},Object.defineProperties(ee.prototype,{rectangle:{get:function(){var t;return e.defined(this._rectangle)||(t=this._polygonHierarchy.positions,this._rectangle=Z(t,this._ellipsoid,this._arcType,this._granularity)),this._rectangle}},textureCoordinateRotationPoints:{get:function(){return e.defined(this._textureCoordinateRotationPoints)||(this._textureCoordinateRotationPoints=function(e){var t=-e._stRotation;if(0==t)return[0,0,0,1,1,0];var r=e._ellipsoid,o=e._polygonHierarchy.positions;e=e.rectangle;return p.Geometry._textureCoordinateRotationPoints(o,t,r,e)}(this)),this._textureCoordinateRotationPoints}}}),function(r,o){return(r=e.defined(o)?ee.unpack(r,o):r)._ellipsoid=t.Ellipsoid.clone(r._ellipsoid),ee.createGeometry(r)}}));