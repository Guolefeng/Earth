define(["exports","./Transforms-d5c6ad6e","./ComponentDatatype-93750d1a","./when-4bbc8319","./RuntimeError-346a3079","./Matrix2-ccd5b911","./GeometryAttribute-c30799b8","./GeometryAttributes-7827a6c2","./GeometryPipeline-548e76d2","./IndexDatatype-b7d979a6","./WebMercatorProjection-b29097b4"],(function(e,t,r,n,i,o,a,s,d,p,u){"use strict";function c(e,t,r){e=n.defaultValue(e,0),t=n.defaultValue(t,0),r=n.defaultValue(r,0),this.value=new Float32Array([e,t,r])}function f(e,t){var n=e.attributes,i=(e=n.position).values.length/e.componentsPerAttribute;n.batchId=new a.GeometryAttribute({componentDatatype:r.ComponentDatatype.FLOAT,componentsPerAttribute:1,values:new Float32Array(i)});for(var o=n.batchId.values,s=0;s<i;++s)o[s]=t}function m(e,t,r,i){var o,a,s,d=i.length-1;s=0<=d?(o=(d=i[d]).offset+d.count,r[a=d.index].indices.length):r[a=o=0].indices.length;for(var p=e.length,u=0;u<p;++u){var c=e[u][t];n.defined(c)&&(s<o+(c=c.indices.length)&&(o=0,s=r[++a].indices.length),i.push({index:a,offset:o,count:c}),o+=c)}}Object.defineProperties(c.prototype,{componentDatatype:{get:function(){return r.ComponentDatatype.FLOAT}},componentsPerAttribute:{get:function(){return 3}},normalize:{get:function(){return!1}}}),c.fromCartesian3=function(e){return new c(e.x,e.y,e.z)},c.toValue=function(e,t){return(t=n.defined(t)?t:new Float32Array([e.x,e.y,e.z]))[0]=e.x,t[1]=e.y,t[2]=e.z,t};var h={};function l(e){var r=e.length,i=1+(t.BoundingSphere.packedLength+1)*r,o=new Float32Array(i),a=0;o[a++]=r;for(var s=0;s<r;++s){var d=e[s];n.defined(d)?(o[a++]=1,t.BoundingSphere.pack(e[s],o,a)):o[a++]=0,a+=t.BoundingSphere.packedLength}return o}function g(e){for(var r=new Array(e[0]),n=0,i=1;i<e.length;)1===e[i++]&&(r[n]=t.BoundingSphere.unpack(e,i)),++n,i+=t.BoundingSphere.packedLength;return r}h.combineGeometry=function(e){var i,a,s,p,u,c,h=e.instances,l=h.length,g=!1;0<l&&(0<(i=function(e){var i=e.instances,a=e.projection,s=e.elementIndexUintSupported,p=e.scene3DOnly,u=e.vertexCacheOptimize,c=e.compressVertices,m=(e=e.modelMatrix,i.length);for(S=0;S<m;++S)if(n.defined(i[S].geometry)){i[S].geometry.primitiveType;break}if(function(e,t,r){var i=!r,a=e.length;if(!i&&1<a)for(var s=e[0].modelMatrix,p=1;p<a;++p)if(!o.Matrix4.equals(s,e[p].modelMatrix)){i=!0;break}if(i)for(p=0;p<a;++p)n.defined(e[p].geometry)&&d.GeometryPipeline.transformToWorldCoordinates(e[p]);else o.Matrix4.multiplyTransformation(t,e[0].modelMatrix,t)}(i,e,p),!p)for(S=0;S<m;++S)n.defined(i[S].geometry)&&d.GeometryPipeline.splitLongitude(i[S]);if(function(e){for(var t=e.length,r=0;r<t;++r){var i=e[r];n.defined(i.geometry)?f(i.geometry,r):n.defined(i.westHemisphereGeometry)&&n.defined(i.eastHemisphereGeometry)&&(f(i.westHemisphereGeometry,r),f(i.eastHemisphereGeometry,r))}}(i),u)for(S=0;S<m;++S){var h=i[S];n.defined(h.geometry)?(d.GeometryPipeline.reorderForPostVertexCache(h.geometry),d.GeometryPipeline.reorderForPreVertexCache(h.geometry)):n.defined(h.westHemisphereGeometry)&&n.defined(h.eastHemisphereGeometry)&&(d.GeometryPipeline.reorderForPostVertexCache(h.westHemisphereGeometry),d.GeometryPipeline.reorderForPreVertexCache(h.westHemisphereGeometry),d.GeometryPipeline.reorderForPostVertexCache(h.eastHemisphereGeometry),d.GeometryPipeline.reorderForPreVertexCache(h.eastHemisphereGeometry))}var l=d.GeometryPipeline.combineInstances(i);for(m=l.length,S=0;S<m;++S){var g,y,b,v,x=(g=l[S]).attributes;if(p)for(y in x)x.hasOwnProperty(y)&&x[y].componentDatatype===r.ComponentDatatype.DOUBLE&&d.GeometryPipeline.encodeAttribute(g,y,y+"3DHigh",y+"3DLow");else for(y in x)x.hasOwnProperty(y)&&x[y].componentDatatype===r.ComponentDatatype.DOUBLE&&(d.GeometryPipeline.projectTo2D(g,y,b=y+"3D",v=y+"2D",a),n.defined(g.boundingSphere)&&"position"===y&&(g.boundingSphereCV=t.BoundingSphere.fromVertices(g.attributes.position2D.values)),d.GeometryPipeline.encodeAttribute(g,b,b+"High",b+"Low"),d.GeometryPipeline.encodeAttribute(g,v,v+"High",v+"Low"));c&&d.GeometryPipeline.compressVertices(g)}if(!s){for(var G=[],S=(m=l.length,0);S<m;++S)g=l[S],G=G.concat(d.GeometryPipeline.fitToUnsignedShortIndices(g));l=G}return l}(e)).length&&(a=d.GeometryPipeline.createAttributeLocations(i[0]),e.createPickOffsets&&(m(p=h,"geometry",u=i,c=[]),m(p,"westHemisphereGeometry",u,c),m(p,"eastHemisphereGeometry",u,c),c=c)),n.defined(h[0].attributes)&&n.defined(h[0].attributes.offset)&&(s=new Array(l),g=!0));for(var y=new Array(l),b=new Array(l),v=0;v<l;++v){var x=h[v],G=x.geometry;n.defined(G)&&(y[v]=G.boundingSphere,b[v]=G.boundingSphereCV,g&&(s[v]=x.geometry.offsetAttribute)),G=x.eastHemisphereGeometry,x=x.westHemisphereGeometry,n.defined(G)&&n.defined(x)&&(n.defined(G.boundingSphere)&&n.defined(x.boundingSphere)&&(y[v]=t.BoundingSphere.union(G.boundingSphere,x.boundingSphere)),n.defined(G.boundingSphereCV)&&n.defined(x.boundingSphereCV)&&(b[v]=t.BoundingSphere.union(G.boundingSphereCV,x.boundingSphereCV)))}return{geometries:i,modelMatrix:e.modelMatrix,attributeLocations:a,pickOffsets:c,offsetInstanceExtend:s,boundingSpheres:y,boundingSpheresCV:b}},h.packCreateGeometryResults=function(e,r){var i=new Float64Array(function(e){for(var r=1,i=e.length,o=0;o<i;o++){var a=e[o];if(++r,n.defined(a)){var s,d=a.attributes;for(s in r+=7+2*t.BoundingSphere.packedLength+(n.defined(a.indices)?a.indices.length:0),d)d.hasOwnProperty(s)&&n.defined(d[s])&&(r+=5+d[s].values.length)}}return r}(e)),o=[],a={},s=e.length,d=0;i[d++]=s;for(var p=0;p<s;p++){var u=e[p],c=n.defined(u);if(i[d++]=c?1:0,c){i[d++]=u.primitiveType,i[d++]=u.geometryType,i[d++]=n.defaultValue(u.offsetAttribute,-1),c=n.defined(u.boundingSphere)?1:0,(i[d++]=c)&&t.BoundingSphere.pack(u.boundingSphere,i,d),d+=t.BoundingSphere.packedLength,c=n.defined(u.boundingSphereCV)?1:0,(i[d++]=c)&&t.BoundingSphere.pack(u.boundingSphereCV,i,d),d+=t.BoundingSphere.packedLength;var f,m=u.attributes,h=[];for(f in m)m.hasOwnProperty(f)&&n.defined(m[f])&&(h.push(f),n.defined(a[f])||(a[f]=o.length,o.push(f)));i[d++]=h.length;for(var l=0;l<h.length;l++){var g=h[l],y=m[g];i[d++]=a[g],i[d++]=y.componentDatatype,i[d++]=y.componentsPerAttribute,i[d++]=y.normalize?1:0,i[d++]=y.values.length,i.set(y.values,d),d+=y.values.length}c=n.defined(u.indices)?u.indices.length:0,0<(i[d++]=c)&&(i.set(u.indices,d),d+=c)}}return r.push(i.buffer),{stringTable:o,packedData:i}},h.unpackCreateGeometryResults=function(e){for(var n=e.stringTable,i=e.packedData,o=new Array(i[0]),d=0,u=1;u<i.length;)if(1===i[u++]){var c,f,m=i[u++],h=i[u++],l=i[u++];-1===l&&(l=void 0),1===i[u++]&&(c=t.BoundingSphere.unpack(i,u)),u+=t.BoundingSphere.packedLength,1===i[u++]&&(f=t.BoundingSphere.unpack(i,u)),u+=t.BoundingSphere.packedLength;var g=new s.GeometryAttributes,y=i[u++];for(A=0;A<y;A++){for(var b=n[i[u++]],v=i[u++],x=i[u++],G=0!==i[u++],S=i[u++],P=r.ComponentDatatype.createTypedArray(v,S),k=0;k<S;k++)P[k]=i[u++];g[b]=new a.GeometryAttribute({componentDatatype:v,componentsPerAttribute:x,normalize:G,values:P})}if(0<(S=i[u++]))for(var C=P.length/x,w=p.IndexDatatype.createTypedArray(C,S),A=0;A<S;A++)w[A]=i[u++];o[d++]=new a.Geometry({primitiveType:m,geometryType:h,boundingSphere:c,boundingSphereCV:f,indices:w,attributes:g,offsetAttribute:l})}else o[d++]=void 0;return o},h.packCombineGeometryParameters=function(e,r){for(var i=e.createGeometryResults,a=i.length,s=0;s<a;s++)r.push(i[s].packedData.buffer);return{createGeometryResults:e.createGeometryResults,packedInstances:function(e,t){var r=e.length,i=new Float64Array(1+19*r),a=0;i[a++]=r;for(var s=0;s<r;s++){var d=e[s];o.Matrix4.pack(d.modelMatrix,i,a),a+=o.Matrix4.packedLength,n.defined(d.attributes)&&n.defined(d.attributes.offset)&&(d=d.attributes.offset.value,i[a]=d[0],i[a+1]=d[1],i[a+2]=d[2]),a+=3}return t.push(i.buffer),i}(e.instances,r),ellipsoid:e.ellipsoid,isGeographic:e.projection instanceof t.GeographicProjection,elementIndexUintSupported:e.elementIndexUintSupported,scene3DOnly:e.scene3DOnly,vertexCacheOptimize:e.vertexCacheOptimize,compressVertices:e.compressVertices,modelMatrix:e.modelMatrix,createPickOffsets:e.createPickOffsets}},h.unpackCombineGeometryParameters=function(e){for(var r=function(e){for(var t=e,r=new Array(t[0]),i=0,a=1;a<t.length;){var s,d=o.Matrix4.unpack(t,a);a+=o.Matrix4.packedLength,n.defined(t[a])&&(s={offset:new c(t[a],t[a+1],t[a+2])}),a+=3,r[i++]={modelMatrix:d,attributes:s}}return r}(e.packedInstances),i=e.createGeometryResults,a=i.length,s=0,d=0;d<a;d++)for(var p=h.unpackCreateGeometryResults(i[d]),f=p.length,m=0;m<f;m++){var l=p[m];r[s].geometry=l,++s}var g=o.Ellipsoid.clone(e.ellipsoid);return{instances:r,ellipsoid:g,projection:new(e.isGeographic?t.GeographicProjection:u.WebMercatorProjection)(g),elementIndexUintSupported:e.elementIndexUintSupported,scene3DOnly:e.scene3DOnly,vertexCacheOptimize:e.vertexCacheOptimize,compressVertices:e.compressVertices,modelMatrix:o.Matrix4.clone(e.modelMatrix),createPickOffsets:e.createPickOffsets}},h.packCombineGeometryResults=function(e,t){n.defined(e.geometries)&&function(e,t){for(var r=e.length,i=0;i<r;++i)!function(e,t){var r,i,o=e.attributes;for(r in o)o.hasOwnProperty(r)&&(i=o[r],n.defined(i)&&n.defined(i.values)&&t.push(i.values.buffer));n.defined(e.indices)&&t.push(e.indices.buffer)}(e[i],t)}(e.geometries,t);var r=l(e.boundingSpheres),i=l(e.boundingSpheresCV);return t.push(r.buffer,i.buffer),{geometries:e.geometries,attributeLocations:e.attributeLocations,modelMatrix:e.modelMatrix,pickOffsets:e.pickOffsets,offsetInstanceExtend:e.offsetInstanceExtend,boundingSpheres:r,boundingSpheresCV:i}},h.unpackCombineGeometryResults=function(e){return{geometries:e.geometries,attributeLocations:e.attributeLocations,modelMatrix:e.modelMatrix,pickOffsets:e.pickOffsets,offsetInstanceExtend:e.offsetInstanceExtend,boundingSpheres:g(e.boundingSpheres),boundingSpheresCV:g(e.boundingSpheresCV)}},e.PrimitivePipeline=h}));